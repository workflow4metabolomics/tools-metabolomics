<tool id="abims_xcms_retcor" name="xcms adjustRtime (retcor)" version="@WRAPPER_VERSION@.0">

    <description>Retention Time Correction</description>

    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements"/>
    <expand macro="stdio"/>

    <command><![CDATA[
        @COMMAND_XCMS_SCRIPT@/xcms_retcor.r
        image '$image'

        method $methods.method
        #if $methods.method == "PeakGroups":
            minFraction $methods.minFraction
            extraPeaks $methods.extraPeaks
            smooth $methods.smooth_cond.smooth
            ## PeakGroupsSmoothLoess Advanced
            span $methods.smooth_cond.PeakGroupsSmoothLoessAdv.span
            family $methods.smooth_cond.PeakGroupsSmoothLoessAdv.family
        #else
            binSize $methods.binSize
        #end if

        @COMMAND_FILE_LOAD@

        @COMMAND_LOG_EXIT@
    ]]></command>

    <inputs>
        <param name="image" type="data" format="rdata.xcms.raw,rdata.xcms.group,rdata" label="xset RData file" help="output file from another function xcms (xcmsSet, retcor etc.)" />
        <conditional name="methods">
            <param name="method" type="select" label="Method to use for retention time correction" help="See the help section below" >
                <option value="PeakGroups" selected="true">PeakGroups - retention time correction based on aligment of features (peak groups) present in most/all samples.</option>
                <option value="Obiwarp">Obiwarp - alignment based on the complete mz-rt data.</option>
            </param>
            <when value="PeakGroups">
                <param argument="minFraction" type="float" value="0.9" min="0" max="1" label="Minimum required fraction of samples in which peaks for the peak group were identified" help="(previously missing)"/>
                <param argument="extraPeaks" type="integer" value="1" label="Maximal number of additional peaks for all samples to be assigned to a peak group for retention time correction"  help="For a data set with 6 samples, ‘extraPeaks = 1’ uses all peak groups with a total peak count lower or equal to ‘6 + 1’. The total peak count is the total number of peaks being assigned to a peak group and considers also multiple peaks within a sample being assigned to the group. (previously extra)" />
                <conditional name="smooth_cond">
                    <param argument="smooth" type="select" label="Smooth method" >
                        <option value="loess" selected="true">loess - non-linear alignment</option>
                        <option value="linear">linear - linear alignment</option>
                    </param>
                    <when value="loess">
                        <section name="PeakGroupsSmoothLoessAdv" title="Advanced Options" expanded="False">
                            <param argument="span" type="float" value="0.2" label="Degree of smoothing for the loess fitting" />
                            <param argument="family" type="select" label="Family" help="if gaussian fitting is by least-squares with no outlier removal, and if symmetric a re descending M estimator is used with Tukey's biweight function, allowing outlier removal">
                                <option value="gaussian" selected="true">gaussian</option>
                                <option value="symmetric">symmetric</option>
                            </param>
                        </section>
                    </when>
                    <when value="linear" />
                </conditional>
            </when>
            <when value="Obiwarp">
                <param argument="binSize" type="float" value="1" label="Bin size (in mz dimension) to be used for the profile matrix generation" help="See ‘step’ parameter in ‘profile-matrix’ documentation for more details. (previously profStep)" />
                <!-- centerSample: -->
                <!-- response: 1 -->
                <!-- distFun: cor_opt -->
                <!-- gapInit: 0.3 -->
                <!-- gapExtend: 2.4 -->
                <!-- factorDiag: 2 -->
                <!-- factorGap: 1 -->
                <!-- localAlignment: FALSE -->
                <!-- initPenalty: 0 -->
            </when>
        </conditional>

        <expand macro="input_file_load"/>

    </inputs>

    <outputs>
        <data name="xsetRData" format="rdata.xcms.retcor" label="${image.name[:-6]}.retcor.RData" from_work_dir="retcor.RData" />
        <data name="rplotsPdf" format="pdf"  label="${image.name[:-6]}.retcor.Rplots.pdf" from_work_dir="Rplots.pdf">
            <filter>(methods['method'] == 'PeakGroups')</filter>
            <filter>(options['option'] == 'show')</filter>
            <filter>(family == 'symmetric')</filter>
        </data>
        <data name="ticsCorPdf"   format="pdf"  label="${image.name[:-6]}.retcor.TICs_corrected.pdf" from_work_dir="TICs.pdf"/>
        <data name="bpcsCorPdf"   format="pdf" label="${image.name[:-6]}.retcor.BPCs_corrected.pdf" from_work_dir="BICs.pdf" />
        <data name="log" format="txt" label="xset.log.txt" from_work_dir="log.txt" hidden="true" />
    </outputs>

    <tests>
        <!--<test>
            <param name="image" value="xset.group.RData"/>
            <conditional name="methods">
                <param name="method" value="PeakGroups"/>
                <param name="extraPeaks" value="1"/>
                <param name="minFraction" value="1"/>
                <conditional name="smooth_cond">
                    <param name="smooth" value="loess"/>
                    <section name="PeakGroupsSmoothLoessAdv">
                        <param name="span" value="0.2"/>
                        <param name="family" value="gaussian"/>
                    </section>
                </conditional>
            </conditional>
            <expand macro="test_file_load_zip_sacuri"/>
            <output name="log">
                <assert_contents>
                    <has_text text="object with 4 samples" />
                    <has_text text="Time range: 0.2-1140.1 seconds (0-19 minutes)" />
                    <has_text text="Mass range: 50.0021-999.9863 m/z" />
                    <has_text text="Peaks: 59359 (about 14840 per sample)" />
                    <has_text text="Peak Groups: 0" />
                    <has_text text="Sample classes: bio, blank" />
                </assert_contents>
            </output>
        </test>-->
        <test>
            <param name="image" value="faahKO.xset.group.RData"/>
            <conditional name="methods">
                <param name="method" value="PeakGroups"/>
                <param name="extraPeaks" value="1"/>
                <param name="minFraction" value="1"/>
                <conditional name="smooth_cond">
                    <param name="smooth" value="loess"/>
                    <section name="PeakGroupsSmoothLoessAdv">
                        <param name="span" value="0.2"/>
                        <param name="family" value="gaussian"/>
                    </section>
                </conditional>
            </conditional>
            <expand macro="test_file_load_zip"/>
            <output name="log">
                <assert_contents>
                    <has_text text="object with 4 samples" />
                    <has_text text="Time range: 2509.2-4480.3 seconds (41.8-74.7 minutes)" />
                    <has_text text="Mass range: 200.1-600 m/z" />
                    <has_text text="Peaks: 9251 (about 2313 per sample)" />
                    <has_text text="Peak Groups: 0" />
                    <has_text text="Sample classes: KO, WT" />
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="image" value="faahKO-single-class.xset.group.RData"/>
            <conditional name="methods">
                <param name="method" value="PeakGroups"/>
                <param name="extraPeaks" value="1"/>
                <param name="minFraction" value="1"/>
                <conditional name="smooth_cond">
                    <param name="smooth" value="loess"/>
                    <section name="PeakGroupsSmoothLoessAdv">
                        <param name="span" value="0.2"/>
                        <param name="family" value="gaussian"/>
                    </section>
                </conditional>
            </conditional>
            <expand macro="test_file_load_single"/>
            <output name="log">
                <assert_contents>
                    <has_text text="object with 4 samples" />
                    <has_text text="Time range: 2509.2-4480.3 seconds (41.8-74.7 minutes)" />
                    <has_text text="Mass range: 200.1-600 m/z" />
                    <has_text text="Peaks: 9251 (about 2313 per sample)" />
                    <has_text text="Peak Groups: 0" />
                    <has_text text="Sample classes: KO, WT" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[

@HELP_AUTHORS@

================
xcms adjustRtime
================

-----------
Description
-----------

After matching peaks into groups, xcms can use those groups to identify and correct
correlated drifts in retention time from run to run. The aligned peaks can then be
used for a second pass of peak grouping which will be more accurate than the first.
The whole process can be repeated in an iterative fashion. Not all peak groups will be helpful
for identifying retention time drifts. Some groups may be missing peaks from a large
fraction of samples and thus provide an incomplete picture of the drift at that time point.
Still others may contain multiple peaks from the same sample, which is a sign of impropper grouping.

.. class:: warningmark

**After an adjustRtime step, it is mandatory to do a groupChromPeaks step, otherwise the rest of the workflow will not work with the RData file. (the initial peak grouping becomes invalid and is
discarded)**



-----------------
Workflow position
-----------------


**Upstream tools**

========================= ================= ======= ==========
Name                      output file       format  parameter
========================= ================= ======= ==========
xcms.group                xset.group.RData  RData   RData file
========================= ================= ======= ==========


**Downstream tools**

+---------------------------+------------------+--------+
| Name                      | Output file      | Format |
+===========================+==================+========+
|xcms.group                 | xset.retcor.RData| RData  |
+---------------------------+------------------+--------+

The output file **xset.retcor.RData** is an RData file. You can continue your analysis using it in **xcms.group** tool as an next step.


**General schema of the metabolomic workflow**

.. image:: xcms_retcor_workflow.png


-----------
Input files
-----------

+---------------------------+----------------------+
| Parameter : num + label   |   Format             |
+===========================+======================+
| 1 : RData file            |   rdata.xcms.group   |
+---------------------------+----------------------+


----------
Parameters
----------

Method
------

**PeakGroups**

    | This method performs retention time adjustment based on the alignment of chromatographic peak groups present in all/most samples (hence corresponding to house keeping compounds). First the retention time deviation of these peak groups is described by fitting either a polynomial (‘smooth = "loess"’) or a linear ( ‘smooth = "linear"’) model to the data points. These models are subsequently used to adjust the retention time of each spectrum in each sample.
    | See the PeakGroups_manual_

**Obiwarp**

    | This method performs retention time adjustment using the Obiwarp method [Prince 2006]. It is based on the code at http://obi-warp.sourceforge.net but supports alignment of multiple samples by aligning each against a _center_ sample. The alignment is performed directly on the ‘profile-matrix’ and can hence be performed independently of the peak detection or peak grouping.
    | See the Obiwarp_manual_

.. _PeakGroups_manual: https://rdrr.io/bioc/xcms/man/adjustRtime-peakGroups.html#heading-2
.. _Obiwarp_manual: https://rdrr.io/bioc/xcms/man/adjustRtime-obiwarp.html

@HELP_XCMS_MANUAL@

------------
Output files
------------

xset.group.retcor.TICs_corrected.pdf

    | "Total Ion Chromatograms" graph in pdf format,corrected after a retcor step.

xset.group.retcor.BPCs_corrected.pdf

    | "Total Io"Base Peak Chromatograms" graph in pdf format,corrected after a retcor step

xset.group.retcor.RData: rdata.xcms.retcor format

    | Rdata file that will be necessary in the **xcms.group** step of the workflow.


------

.. class:: infomark

The output file is an xset.retcor.RData file. You can continue your analysis using it in **xcms.fillPeaks** tool.


---------------------------------------------------

---------------
Working example
---------------

Input files
-----------

    | RData file -> **xset.group.RData**

Parameters
----------

    | Method: -> **PeakGroups**
    | smooth: -> **loess**
    | extraPeaks: -> **1**
    | minFraction -> **1**
    | Advanced options: -> **show**
    | span -> **0.2**
    | family -> **gaussian**
    | plottype -> **deviation**


Output files
------------

    | **1) xset.group.retcor.RData: RData file**

    | **2) Example of an xset.group.retcor.TICs_corrected pdf file**

.. image:: xcms_retcor.png


---------------------------------------------------

Changelog/News
--------------

**Version 3.0.0.0 - 14/02/2018**

- UPGRADE: upgrade the xcms version from 1.46.0 to 3.0.0. So refactoring of a lot of underlining codes and methods

**Version 2.1.1 - 29/11/2017**

- BUGFIX: To avoid issues with accented letter in the parentFile tag of the mzXML files, we changed a hidden mechanim to LC_ALL=C

**Version 2.1.0 - 03/02/2017**

- IMPROVEMENT: xcms.retcor can deal with merged individual data

**Version 2.0.8 - 22/12/2016**

- BUGFIX: when having only one group (i.e. one folder of raw data) the BPC and TIC pdf files do not contain any graph

**Version 2.0.7 - 06/07/2016**

- UPGRADE: upgrate the xcms version from 1.44.0 to 1.46.0

**Version 2.0.6 - 04/04/2016**

- TEST: refactoring to pass planemo test using conda dependencies


**Version 2.0.5 - 10/02/2016**

- BUGFIX: better management of errors. Datasets remained green although the process failed

- BUGFIX: some pdf remained empty even when the process succeed

- UPDATE: refactoring of internal management of inputs/outputs

- UPDATE: refactoring to feed the new report tool


**Version 2.0.2 - 02/06/2015**

- IMPROVEMENT: new datatype/dataset formats (rdata.xcms.raw, rdata.xcms.group, rdata.xcms.retcor ...) will facilitate the sequence of tools and so avoid incompatibility errors.

- IMPROVEMENT: parameter labels have changed to facilitate their reading.


    ]]></help>


    <expand macro="citation" />

</tool>
