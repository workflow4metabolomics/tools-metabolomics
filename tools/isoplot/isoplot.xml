<tool id="graphstatsr" name="GraphstatsR" version="2.6.1" profile="23.0">
  <description>Exécute la fonction graphstatsr::IsoPlot_fun()</description>

  <requirements>
    <requirement type="package" version="2.6.1">r-graphstatsr</requirement>
    <requirement type="package" version="4.4.3">r-base</requirement>
  </requirements>

  <stdio>
    <regex match="Error" source="stderr" level="fatal" />
    <regex match="Fatal" source="stderr" level="fatal" />
    <exit_code range="1:" level="fatal" />
  </stdio>

  <command><![CDATA[
    Rscript -e "library(graphstatsr);
    print('Running GraphstatsR');
    graphstatsr::IsoPlot_fun(feat_table = '$feat_tab', metadata_table = '$meta_tab', groups = '$groups', relativeCID = '$relative_cid', dodgeCID = '$dodge_cid', outpath = './isoplot_results', pdf = TRUE, img = TRUE);
    print('OK');
    print(getwd());
    tar('isoplot_results.tgz', list.files('./isoplot_results', full.names = TRUE), compression = 'gzip');
    print(dir());
    print(file.exists('isoplot_results.tgz'))"
  ]]></command>

  <inputs>
        <param name='feat_tab' type='data' format='tabular' label='Upload feature table data that has been corrected by Isocor (tabular/tsv format)' />
        <param name='meta_tab' type='data' format='tabular,csv' label='Upload metadata table (tabular, tsv, csv format)'/>
        <param name='groups' type='text' value='sample' label='Column name for grouping variable'/>
        <param name='relative_cid' type='boolean' truevalue='TRUE' falsevalue='FALSE' checked='true' label='Use relative CID values'/>
        <param name='dodge_cid' type='boolean' truevalue='TRUE' falsevalue='FALSE' checked='false' label='Dodge CID values'/>
  </inputs>

  <outputs>
    <data name="out_tgz" label="isoplot_results.tgz" format="tgz" from_work_dir="isoplot_results.tgz"/>
  </outputs>


<tests>
    <test expect_num_outputs="1">
        <param name="feat_tab" value="02_isoplot_quantification_table_small.tsv" ftype="tabular"/>
        <param name="meta_tab" value="02_isoplot_metadata_small.tsv" ftype="tabular"/>
        <output name="out_tgz" file="isoplot_results.tgz" compare="sim_size" delta="20000" />
    </test>

        <!-- Test négatif : fichiers inversés (doit échouer) -->
    <test expect_failure="true">
        <param name="feat_tab" value="02_isoplot_metadata_small.csv"/>
        <param name="meta_tab" value="02_isoplot_quantification_table_small.tsv"/>
        <assert_stderr>
            <has_text text="Error"/>
        </assert_stderr>
    </test>
</tests>



  <help><![CDATA[

  .. class:: warningmark

================
ISOPLOT
================

-----------
Description
-----------

  Read the `documentation <https://graphstats-a3d646.pages-forge.inrae.fr/reference/IsoPlot_fun.html>`_ of IsoPlot.

  Isoplot is a software for the visualisation of MS data from C13 labelling experiments. It takes as input corrected MS data from IsoCor in tsv format. Isoplot outputs static plots that are then used for quality assessment, biological interpretation, project reports, published papers and so forth. First version of Isoplot (https://github.com/llegregam/Isoplot) has been developed in 2021. This new version of Isoplot is now integrated in the R package GraphStatsR (https://forge.inrae.fr/etienne.rifa/graphstats). It has been re-written using the R Shiny framework to provide a more user-friendly interface and new functionalities.

  Online instance of GraphstatsR including IsoPlot: `https://graphstatsr.sk8.inrae.fr/ <https://graphstatsr.sk8.inrae.fr/>`_.

---------------------------------------------------

-----------
Parameters
-----------

=============  ====================================================================
Parameter      Description
=============  ====================================================================
feat_table     Feature table corrected by IsoCor (CSV or TSV format)
metadata       Metadata table describing samples and experimental groups
groups         Column name in metadata to use for grouping samples
relativeCID    Display relative CID values (TRUE/FALSE)
dodgeCID       Use dodged layout for CID plots (TRUE/FALSE)
=============  ====================================================================

---------------------------------------------------

-----------
Output
-----------
An archive (tgz) containing the following elements:

- Isoplot A list of ggplot objects containing the barplots of the experimental isotopologue fraction of each metabolite with error bars

- EnrC13_TotArea A list of ggplot objects containing the barplots of the mean EnrC13 and Total Area of each metabolite (one figure per metabolite)

- EnrC13_TotArea_allMet A list of ggplot objects containing the barplots of the mean EnrC13 and Total Area of all metabolites (one figure per sample or group of samples)
      ]]>
  </help>

  <citations>
      <citation type='bibtex'>
      @Manual{docGraphstatsR,
        title = {GraphstatsR, A shiny app allowing users to generate advanced interactive graphics and statistical tests for metabolomic data.},
        author = {Etienne Rifa},
        year = {2025},
        note = {R package version 2.5.0},
        url = {https://forge.inrae.fr/etienne.rifa/graphstats},
      }
      </citation>
  </citations>

</tool>